<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="fas fa-tachometer-alt"></i> Custom Dashboards
            </h2>
            <p class="text-muted">Create and manage custom real-time dashboards with sensors and gauges</p>
        </div>
        <div class="col-md-4 text-right">
            <button id="createDashboardBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create New Dashboard
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div id="dashboardsLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <div id="dashboardsList" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Widgets</th>
                                        <th>Updated</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboardsTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div id="noDashboards" class="text-center py-5" style="display: none;">
                            <i class="fas fa-tachometer-alt fa-4x text-muted mb-3"></i>
                            <h4>No dashboards yet</h4>
                            <p class="text-muted">Create your first custom dashboard to get started</p>
                        </div>
                    </div>
                </div>
            </card>
        </div>
    </div>
</div>

<!-- Create Dashboard Modal -->
<div class="modal fade" id="createDashboardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Dashboard</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createDashboardForm">
                    <div class="form-group">
                        <label>Dashboard Name</label>
                        <input type="text" class="form-control" id="dashboardName" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="dashboardDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Resolution</label>
                        <select class="form-control" id="dashboardResolution">
                            <option value="1920x1080">1920x1080 (Full HD)</option>
                            <option value="1280x720">1280x720 (HD)</option>
                            <option value="3840x2160">3840x2160 (4K)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div id="customResolution" style="display: none;">
                        <div class="row">
                            <div class="col-6">
                                <input type="number" class="form-control" id="customWidth" placeholder="Width">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control" id="customHeight" placeholder="Height">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCreateDashboard">Create</button>
            </div>
        </div>
    </div>
</div>

<script src="/js/lib/jquery-3.3.1.min.js"></script>
<script src="/js/lib/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function() {
    loadDashboards();

    $('#createDashboardBtn').click(function() {
        $('#createDashboardModal').modal('show');
    });

    $('#dashboardResolution').change(function() {
        if ($(this).val() === 'custom') {
            $('#customResolution').show();
        } else {
            $('#customResolution').hide();
        }
    });

    $('#confirmCreateDashboard').click(function() {
        const name = $('#dashboardName').val();
        const description = $('#dashboardDescription').val();
        const resolution = $('#dashboardResolution').val();
        
        let width = 1920, height = 1080;
        if (resolution !== 'custom') {
            [width, height] = resolution.split('x').map(Number);
        } else {
            width = parseInt($('#customWidth').val()) || 1920;
            height = parseInt($('#customHeight').val()) || 1080;
        }

        createDashboard(name, description, width, height);
    });

    function loadDashboards() {
        $.ajax({
            url: '/api/dashboards',
            method: 'GET',
            success: function(dashboards) {
                $('#dashboardsLoading').hide();
                $('#dashboardsList').show();
                
                if (dashboards.length === 0) {
                    $('#noDashboards').show();
                    $('table').hide();
                } else {
                    $('#noDashboards').hide();
                    $('table').show();
                    renderDashboards(dashboards);
                }
            },
            error: function(err) {
                console.error('Failed to load dashboards:', err);
                $('#dashboardsLoading').hide();
            }
        });
    }

    function renderDashboards(dashboards) {
        const tbody = $('#dashboardsTableBody');
        tbody.empty();

        dashboards.forEach(dashboard => {
            const widgetCount = dashboard.config?.widgets?.length || 0;
            const updatedAt = new Date(dashboard.updatedAt).toLocaleString();
            const isPublic = dashboard.isPublic;

            const row = $(`
                <tr>
                    <td><strong>${dashboard.name}</strong></td>
                    <td>${dashboard.description || '-'}</td>
                    <td>${widgetCount} widgets</td>
                    <td>${updatedAt}</td>
                    <td>
                        ${isPublic ? '<span class="badge badge-success">Public</span>' : '<span class="badge badge-secondary">Private</span>'}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="/dashboard/editor/${dashboard.id}" class="btn btn-primary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="/dashboard/view/${dashboard.id}" class="btn btn-info" title="View">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-warning" onclick="toggleShare('${dashboard.id}')" title="Share">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="btn btn-secondary" onclick="duplicateDashboard('${dashboard.id}')" title="Duplicate">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteDashboard('${dashboard.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `);
            tbody.append(row);
        });
    }

    function createDashboard(name, description, width, height) {
        $.ajax({
            url: '/api/dashboards',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                name: name,
                description: description,
                config: {
                    widgets: [],
                    settings: {
                        backgroundColor: '#1a1a1a',
                        backgroundImage: null,
                        gridSize: 20,
                        width: width,
                        height: height
                    }
                }
            }),
            success: function(dashboard) {
                $('#createDashboardModal').modal('hide');
                window.location.href = '/dashboard/editor/' + dashboard.id;
            },
            error: function(err) {
                console.error('Failed to create dashboard:', err);
                alert('Failed to create dashboard');
            }
        });
    }

    window.toggleShare = function(dashboardId) {
        $.ajax({
            url: `/api/dashboards/${dashboardId}/share`,
            method: 'PATCH',
            success: function(dashboard) {
                if (dashboard.isPublic) {
                    const url = `${window.location.origin}/dashboard/live/${dashboard.shareId}`;
                    prompt('Dashboard is now public. Browser source URL:', url);
                } else {
                    alert('Dashboard is now private');
                }
                loadDashboards();
            },
            error: function(err) {
                console.error('Failed to toggle share:', err);
                alert('Failed to toggle share');
            }
        });
    };

    window.duplicateDashboard = function(dashboardId) {
        $.ajax({
            url: `/api/dashboards/${dashboardId}/duplicate`,
            method: 'POST',
            success: function() {
                loadDashboards();
            },
            error: function(err) {
                console.error('Failed to duplicate dashboard:', err);
                alert('Failed to duplicate dashboard');
            }
        });
    };

    window.deleteDashboard = function(dashboardId) {
        if (confirm('Are you sure you want to delete this dashboard?')) {
            $.ajax({
                url: `/api/dashboards/${dashboardId}`,
                method: 'DELETE',
                success: function() {
                    loadDashboards();
                },
                error: function(err) {
                    console.error('Failed to delete dashboard:', err);
                    alert('Failed to delete dashboard');
                }
            });
        }
    };
});
</script>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}
</style>

